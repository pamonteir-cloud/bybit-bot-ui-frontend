<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit Auto-Trader Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos customizados para o log */
        #log-output {
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 13px;
            background-color: #1f2937; /* Dark background */
            color: #ffffff;
            border-radius: 0.375rem;
            padding: 0.75rem;
        }
        .log-entry {
            line-height: 1.5;
        }
        .log-prefix {
            font-weight: bold;
        }
        .log-info { color: #9ca3af; }
        .log-success { color: #10b981; }
        .log-error { color: #f87171; }
        .log-warn { color: #fbbf24; }
        .log-check { color: #60a5fa; }
        .log-optimize { color: #a78bfa; }
        .log-buy { color: #10b981; }
        .log-sell { color: #f87171; }
        
        .text-bybit-red { color: #e73030; }
        .text-bybit-green { color: #00bf8a; }
        .text-bybit-orange { color: #f0b90b; }

        .active-tf {
            background-color: #f0b90b; /* Cor de destaque */
            color: white;
            font-weight: bold;
            border-color: #f0b90b;
        }
    </style>
</head>
<body class="bg-gray-800 text-white min-h-screen p-4">

    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-700 p-6 rounded-lg shadow-xl max-w-sm">
            <h2 class="text-xl font-bold text-red-400 mb-4">Erro Cr√≠tico</h2>
            <p id="errorMessage" class="text-gray-200 mb-6"></p>
            <button onclick="closeErrorModal()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                Fechar
            </button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <header class="mb-6 border-b border-gray-700 pb-3 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-bybit-orange">Bybit Auto-Trader ü§ñ</h1>
            <p class="text-sm text-gray-400">Desenvolvido para PAMONTEIR</p>
        </header>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-700 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-gray-300 mb-1">Status do Bot</h2>
                <div class="flex items-center">
                    <span id="botStatus" class="text-xl font-bold text-bybit-red mr-2">PARADO</span>
                    <div id="loading-spinner" class="h-4 w-4 border-2 border-gray-200 border-t-bybit-orange rounded-full animate-spin hidden"></div>
                </div>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-gray-300 mb-1">Ativo Atual / PNL</h2>
                <p id="currentHolding" class="text-xl font-bold">USDT / PNL: NA</p>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-gray-300 mb-1">Saldo Atual</h2>
                <p id="currentBalance" class="text-xl font-bold">0.00000000 USDT</p>
            </div>
        </div>

        <div class="bg-gray-700 p-4 rounded-lg shadow-md mb-6 flex justify-between space-x-4">
            <button id="startButton" onclick="startBot()" class="w-1/2 bg-bybit-green hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg transition duration-150 ease-in-out disabled:opacity-50" disabled>
                INICIAR BOT
            </button>
            <button id="stopButton" onclick="stopBot()" class="w-1/2 bg-bybit-red hover:bg-red-700 text-white font-bold py-3 rounded-lg text-lg transition duration-150 ease-in-out disabled:opacity-50" disabled>
                PARAR BOT
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-700 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-gray-300 mb-2">Timeframe (RSI)</h2>
                <div class="flex space-x-2">
                    <button data-tf="5" class="tf-btn bg-gray-600 hover:bg-gray-500 text-white py-1 px-3 rounded text-sm transition duration-150 ease-in-out">5m</button>
                    <button data-tf="15" class="tf-btn bg-gray-600 hover:bg-gray-500 text-white py-1 px-3 rounded text-sm transition duration-150 ease-in-out">15m</button>
                    <button data-tf="60" class="tf-btn bg-gray-600 hover:bg-gray-500 text-white py-1 px-3 rounded text-sm transition duration-150 ease-in-out">1h</button>
                    <button data-tf="240" class="tf-btn bg-gray-600 hover:bg-gray-500 text-white py-1 px-3 rounded text-sm transition duration-150 ease-in-out">4h</button>
                </div>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-gray-300 mb-2">Monitoramento</h2>
                <div class="p-2 bg-gray-600 rounded-lg text-sm text-gray-300">
                    <p>Ativo monitorado: BTCUSDT</p>
                    <p>Sincronizando com o Back-end...</p>
                </div>
            </div>
        </div>
        
        <div id="auth-status" class="hidden"></div>
        <p id="userIdDisplay" class="text-xs text-gray-500 text-center mb-4">Autentica√ß√£o: N/A</p>

        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-300 mb-2 flex justify-between items-center">
                Log de Atividade
                <button onclick="downloadLog()" class="bg-gray-600 hover:bg-gray-500 text-white text-xs py-1 px-2 rounded transition duration-150 ease-in-out">
                    Download Log
                </button>
            </h2>
            <div id="log-output" class="h-96">
                </div>
        </div>
    </div>
    
    <script type="module">
    // =================================================================
    // CONFIGURA√á√ÉO CR√çTICA (FINAL)
    // =================================================================
    
    // A URL do seu servi√ßo Back-end no Render
    const BACKEND_URL = 'https://bybit-trading-backend-pg6g.onrender.com'; 

    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Vari√°veis Globais (Mantidas apenas para leitura de estado)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db, auth;
    let userId = null;
    let isAuthReady = false;
    
    // Constantes mantidas apenas para refer√™ncias na UI
    const BASE_COIN = 'USDT'; 
    const SOURCE_ACCOUNT = 'FUND'; 

    // Estado do Bot (Sincronizado com Firestore)
    let botState = {
        isRunning: false,
        currentHolding: 'USDT', 
        currentAccountType: SOURCE_ACCOUNT, 
        timeframe: '60', 
        balanceAmount: 0, 
        entryPrice: 0, 
    };

    // --- Configura√ß√µes de UI/Log ---
    let isUserScrolling = false; 
    const logOutput = document.getElementById('log-output');

    if (logOutput) {
        logOutput.addEventListener('wheel', (e) => {
            if (e.deltaY < 0) {
                isUserScrolling = true;
            } 
            else if (logOutput.scrollHeight - logOutput.clientHeight <= logOutput.scrollTop + 50) {
                isUserScrolling = false;
            }
        });
    }

    /** Registra uma mensagem no log da UI com auto-scroll. */
    function logMessage(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('pt-BR');
        let colorClass = 'log-info';
        let prefix = ' [INFO] ';
        
        switch(type) {
            case 'success': colorClass = 'log-success'; prefix = ' [SUCESSO] '; break;
            case 'error': colorClass = 'log-error'; prefix = ' [ERRO] '; break; 
            case 'warn': colorClass = 'log-warn'; prefix = ' [ALERTA] '; break;
            case 'check': colorClass = 'log-check'; prefix = ' [VERIFICA√á√ÉO] '; break; 
            case 'optimize': colorClass = 'log-optimize'; prefix = ' [OTIMIZA√á√ÉO] '; break;
            case 'buy': colorClass = 'log-buy'; prefix = ' [COMPRA] '; break; 
            case 'sell': colorClass = 'log-sell'; prefix = ' [VENDA] '; break; 
            case 'routine': console.log(`[${timestamp}] [ROTINA] ${message}`); return; 
        }
        
        const logEntry = document.createElement('div');
        logEntry.classList.add('log-entry', colorClass);
        logEntry.innerHTML = `[${timestamp}] <span class="log-prefix">${prefix}</span><span class="log-text">${message}</span>`;

        if (logOutput) {
            logOutput.appendChild(logEntry); 
            if (!isUserScrolling) {
                logOutput.scrollTop = logOutput.scrollHeight;
            }
            if (logOutput.children.length > 500) {
                logOutput.removeChild(logOutput.firstChild);
            }
        } else {
            console.log(`[${timestamp}] [${prefix.trim()}] ${message}`);
        }
    }

    window.downloadLog = () => {
        const logWindow = document.getElementById('log-output');
        if (!logWindow) {
            alert("Erro: Elemento de log n√£o encontrado.");
            return;
        }
        
        let logText = "--- Bot Trading Log (Bybit/RSI/Volume) ---\n";
        for (let i = 0; i < logWindow.children.length; i++) {
            logText += logWindow.children[i].textContent.trim() + "\n";
        }

        const filename = `BybitBot_Log_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
        const blob = new Blob([logText], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        logMessage(`Log salvo com sucesso como: ${filename}`, 'success');
    };

    // --- Fun√ß√µes de Utilidade (Modal, Firebase) ---
    
    window.closeErrorModal = () => {
        document.getElementById('errorModal').classList.add('hidden');
    };
    
    function showErrorModal(message) {
        document.getElementById('errorMessage').innerText = message;
        document.getElementById('errorModal').classList.remove('hidden');
        logMessage(`Modal de Erro: ${message}`, 'error');
    }

    async function initializeFirebase() {
        try {
            if (Object.keys(firebaseConfig).length === 0) {
                logMessage('Configura√ß√£o do Firebase ausente. O estado n√£o ser√° persistido.', 'warn');
                isAuthReady = true;
                userId = 'offline_user';
                updateUIStatus();
                return;
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    logMessage(`Usu√°rio autenticado: ${userId}.`, 'info');
                    isAuthReady = true;
                    document.getElementById('userIdDisplay').innerText = userId;
                    setupFirestoreListeners();
                    updateUIStatus();
                } else {
                    logMessage('Nenhum usu√°rio autenticado.', 'error');
                    isAuthReady = true;
                    userId = 'unauthenticated';
                    document.getElementById('userIdDisplay').innerText = 'N√£o Autenticado';
                    updateUIStatus();
                }
            });
        } catch (e) {
            console.error("Erro ao inicializar Firebase:", e);
            logMessage(`Falha na inicializa√ß√£o do Firebase: ${e.message}`, 'error');
            isAuthReady = true;
            userId = 'init_failed';
            document.getElementById('userIdDisplay').innerText = 'Falha na Inicializa√ß√£o';
            updateUIStatus(); 
        }
    }

    function setupFirestoreListeners() {
        if (!db || !userId) return;
        const userStateRef = doc(db, `bot_state/current_state_${userId}`); 

        onSnapshot(userStateRef, (docSnap) => {
            if (docSnap.exists()) {
                const savedState = docSnap.data();
                
                // A UI L√ä O ESTADO SALVO PELO BOT NA NUVEM
                botState.isRunning = savedState.isRunning ?? false;
                botState.currentHolding = savedState.currentHolding ?? 'USDT'; 
                botState.timeframe = savedState.timeframe ?? '60';
                botState.balanceAmount = savedState.balanceAmount ?? 0;
                botState.entryPrice = savedState.entryPrice ?? 0;
                
                updateUIStatus();
                
                logMessage('Estado do bot sincronizado do Firestore.', 'info');
            } else {
                saveBotState();
                logMessage('Iniciando novo estado do bot no Firestore.', 'info');
            }
        }, (error) => {
            console.error("Erro no Listener do Firestore:", error);
            logMessage(`Erro ao ouvir estado do bot: ${error.message}`, 'error');
        });
    }

    // A fun√ß√£o saveBotState √© mantida para que a UI possa iniciar o documento
    async function saveBotState() {
        if (!db || !userId) return;
        const userStateRef = doc(db, `bot_state/current_state_${userId}`); 
        try {
            await setDoc(userStateRef, {
                isRunning: botState.isRunning,
                currentHolding: botState.currentHolding,
                timeframe: botState.timeframe,
                // O BOT NA NUVEM DEVE SALVAR balanceAmount E entryPrice
                lastUpdateUI: new Date().toISOString() // Marcador de atualiza√ß√£o da UI
            }, { merge: true });
        } catch (e) {
            console.error("Erro ao salvar estado do bot:", e);
            logMessage(`Falha ao salvar estado no Firestore: ${e.message}`, 'error');
        }
    }
    
    // =================================================================
    // FUN√á√ïES DE CONTROLE (REFATORADAS PARA USAR A API DO BACK-END)
    // =================================================================

    /** Envia o comando de INICIAR para o Back-end (server.js). */
    window.startBot = async () => {
        if (botState.isRunning) {
            logMessage("Bot j√° est√° em execu√ß√£o (Sincronizado via Firestore).", 'warn');
            return;
        }
        
        logMessage("Enviando comando de INICIAR ao servidor (API)...", 'info');
        try {
            const response = await fetch(`${BACKEND_URL}/api/start`, { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                logMessage(`‚úÖ Comando START enviado ao servidor com sucesso. Servidor respondeu: ${data.message}`, 'success');
            } else {
                logMessage(`‚ùå Falha ao iniciar bot via API: ${data.message}`, 'error');
            }
        } catch (e) {
            logMessage(`‚ùå Falha de conex√£o ao enviar START para API (${BACKEND_URL}): ${e.message}`, 'error');
        }
        // O Firestore Listener ir√° detectar a mudan√ßa de 'isRunning' e atualizar a UI.
    };

    /** Envia o comando de PARAR para o Back-end (server.js). */
    window.stopBot = async () => {
        if (!botState.isRunning) {
            logMessage("Bot j√° est√° parado (Sincronizado via Firestore).", 'warn');
            return;
        }

        logMessage("Enviando comando de PARAR ao servidor (API)...", 'warn');
        try {
            const response = await fetch(`${BACKEND_URL}/api/stop`, { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                logMessage(`‚úÖ Comando STOP enviado ao servidor com sucesso. Servidor respondeu: ${data.message}`, 'warn');
            } else {
                logMessage(`‚ùå Falha ao parar bot via API: ${data.message}`, 'error');
            }
        } catch (e) {
            logMessage(`‚ùå Falha de conex√£o ao enviar STOP para API (${BACKEND_URL}): ${e.message}`, 'error');
        }
        // O Firestore Listener ir√° detectar a mudan√ßa de 'isRunning' e atualizar a UI.
    };

    /** Atualiza o status da interface. */
    function updateUIStatus() {
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const botStatus = document.getElementById('botStatus');
        const loadingSpinner = document.getElementById('loading-spinner');
        const currentHoldingDisplay = document.getElementById('currentHolding');
        const currentBalanceDisplay = document.getElementById('currentBalance');
        const tfButtons = document.querySelectorAll('.tf-btn');
        const authStatus = document.getElementById('auth-status');

        if (startButton && stopButton) {
            if (botState.isRunning) {
                startButton.disabled = true;
                stopButton.disabled = false;
                botStatus.innerText = "EXECUTANDO";
                botStatus.classList.remove('text-bybit-red', 'text-bybit-orange');
                botStatus.classList.add('text-bybit-green');
                loadingSpinner.classList.remove('hidden');
            } else {
                startButton.disabled = false;
                stopButton.disabled = true;
                botStatus.innerText = "PARADO";
                botStatus.classList.remove('text-bybit-green', 'text-bybit-orange');
                botStatus.classList.add('text-bybit-red');
                loadingSpinner.classList.add('hidden');
            }
        } 

        // PNL baseado no entryPrice (que deve ser atualizado pelo bot_logic.js no Firebase)
        let pnlDisplay = '--%';
        if (botState.currentHolding !== BASE_COIN && botState.entryPrice > 0) {
             pnlDisplay = 'Aguardando Sincroniza√ß√£o...'; 
        } else if (botState.currentHolding === BASE_COIN) {
             pnlDisplay = 'NA';
        }
        
        if (currentHoldingDisplay) currentHoldingDisplay.innerText = `${botState.currentHolding} / PNL: ${pnlDisplay}`;
        if (currentBalanceDisplay) currentBalanceDisplay.innerText = `${botState.balanceAmount.toFixed(8)} ${botState.currentHolding}`;

        tfButtons.forEach(btn => {
            btn.classList.remove('active-tf');
            if (btn.getAttribute('data-tf') === botState.timeframe) {
                btn.classList.add('active-tf');
            }
        });
        
        if (authStatus) {
            if (isAuthReady && userId !== 'offline_user' && userId !== 'init_failed' && userId !== 'unauthenticated') {
                 authStatus.style.display = 'block';
                 authStatus.className = 'p-2 text-sm rounded-lg text-center bg-green-100 text-green-700';
                 authStatus.innerText = '‚úÖ Firestore Conectado (Estado Persistido)';
            } else if (userId === 'offline_user') {
                 authStatus.style.display = 'block';
                 authStatus.className = 'p-2 text-sm rounded-lg text-center bg-yellow-100 text-yellow-700';
                 authStatus.innerText = '‚ö†Ô∏è Modo Offline: Sem Persist√™ncia de Estado';
            } else if (userId === 'unauthenticated' || userId === 'init_failed') {
                 authStatus.style.display = 'block';
                 authStatus.className = 'p-2 text-sm rounded-lg text-center bg-red-100 text-red-700';
                 authStatus.innerText = '‚ùå Firebase/Autentica√ß√£o Pendente/Falha';
            }
        }
    }

    // --- Inicializa√ß√£o (ENVELOPADO EM DOMContentLoaded) ---
    
    document.addEventListener('DOMContentLoaded', (event) => {
        logMessage("DOM totalmente carregado. Iniciando servi√ßos...", 'info');
        
        // CORRE√á√ÉO CR√çTICA: Listener de Timeframe agora faz a chamada API
        document.querySelectorAll('.tf-btn').forEach(button => {
            button.addEventListener('click', async function() {
                const newTimeframe = this.getAttribute('data-tf');
                logMessage(`Enviando comando de altera√ß√£o de Timeframe para ${newTimeframe} min...`, 'info');
                
                try {
                    const response = await fetch(`${BACKEND_URL}/api/set-timeframe`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ timeframe: newTimeframe })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        logMessage(`‚úÖ Timeframe alterado no servidor para **${newTimeframe} min**!`, 'success');
                    } else {
                        logMessage(`‚ùå Falha ao alterar Timeframe via API: ${data.message}`, 'error');
                    }
                } catch (e) {
                    logMessage(`‚ùå Falha de conex√£o ao enviar Timeframe para API (${BACKEND_URL}): ${e.message}`, 'error');
                }
                // O Firestore Listener ir√° detectar a mudan√ßa e atualizar a UI.
            });
        });

        // REMOVIDO: fetchAndFilterSpotSymbols() - Isso √© trabalho do servidor
        
        const monitoredDisplay = document.querySelector('.p-2.bg-green-50 p:nth-child(2)');
        if (monitoredDisplay) {
            monitoredDisplay.innerText = `Sincronizando com o Back-end...`;
        }

        initializeFirebase(); 
        updateUIStatus();
    });

</script>
</body>
</html>
